<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.park.ParkingRecordMapper">
   <!-- <resultMap id="MapPlace" type="com.tgy.rtls.data.entity.park.MapPlace">
        <id property="id" column="id"/>
        <result column="mapName"  property="mapName" />
        <result column="describe"  property="describe" />
        <result column="lng"  property="lng" />
        <result column="lat"  property="lat" />
        <result column="total"  property="total" />
        <result column="empty"  property="empty" />
        <collection property="places"  javaType="java.util.List" ofType="com.tgy.rtls.data.entity.park.ParkingPlace">
                <id column="place_id" jdbcType="INTEGER" property="id" />
                <result column="x"  property="x" />
                <result column="y"  property="y" />
                <result column="z"  property="z" />
                <result column="floor"  property="floor" />
                 <result column="fid"  property="fid" />
                <result column="place_name"  property="name" />
                <result column="type"  property="type" />
    </collection>
    </resultMap>-->
   <!-- <resultMap id="findPlaceUserRecordByTime" type="com.tgy.rtls.data.entity.park.PlaceUseRecordData">
        <id property="id" column="id"/>
        <result column="companyName"  property="companyName" />
        <result column="total"  property="total" />
        <result column="empty"  property="empty" />
        <collection property="places"  javaType="java.util.List" ofType="com.tgy.rtls.data.entity.park.ParkingPlace">
            <id column="place_id" jdbcType="INTEGER" property="id" />
            <result column="x"  property="x" />
            <result column="y"  property="y" />
            <result column="z"  property="z" />
            <result column="floor"  property="floor" />
            <result column="place_name"  property="name" />
            <result column="type"  property="type" />
            <result column="fid"  property="fid" />
            <result column="map"  property="map" />
        </collection>
    </resultMap>-->
    <select id="findPlaceUserRecordByTime" resultType="com.tgy.rtls.data.entity.park.PlaceUseRecordData">
        SELECT place_userecord.place,
        parking_place.map,
        parking_place.name AS placeName,
        COUNT(place_userecord.`id`) AS `count`,
        SUM(
        TIMESTAMPDIFF(
        MINUTE ,
        CASE WHEN #{start} > place_userecord.start THEN #{start} ELSE place_userecord.start END,
        CASE WHEN place_userecord.end IS NULL or place_userecord.end > #{end}  THEN #{end} ELSE place_userecord.end END
        ))/60 AS `time`
        FROM place_userecord
            JOIN parking_place ON place_userecord.place = parking_place.id
        WHERE 1=1
        <if test="map!=null ">
            and place_userecord.map=#{map}
        </if>
        and place_userecord.start between #{start} and #{end} and place_userecord.end is not null
        GROUP BY place_userecord.place,parking_place.map,placeName
        ORDER BY ${content} DESC LIMIT 10
    </select>

    <select id="findPlaceChargeRecordByTime" resultType="com.tgy.rtls.data.entity.park.PlaceChargeRecordData">
        SELECT place_chargerecord.place,
        parking_place.map,parking_place.name AS placeName,
        COUNT(place_chargerecord.`id`) AS `count`,
        SUM(TIMESTAMPDIFF(MINUTE ,
        CASE WHEN #{start}> place_chargerecord.start THEN #{start} ELSE place_chargerecord.start END,
        CASE WHEN place_chargerecord.end IS NULL or place_chargerecord.end>#{end}  THEN #{end} ELSE place_chargerecord.end END
        ))/60 AS `time`
        FROM place_chargerecord ,parking_place
        WHERE 1=1  AND place_chargerecord.place=parking_place.id
        <if test="map!=null ">
            and place_chargerecord.map=#{map}
        </if>
        and place_chargerecord.start between #{start} and #{end}
        GROUP BY place_chargerecord.place ORDER BY  #{content} DESC LIMIT 10
    </select>
    <select id="getPlaceMapFeeAndFlow" resultType="com.tgy.rtls.data.entity.park.FeeAndFlow">
        SELECT
        COUNT(fee_flow.`id`) AS `count`,
        SUM(fee_flow.fee) AS fee
        FROM fee_flow
        WHERE 1=1
        <if test="map!=null ">
            and map=#{map}
        </if>
        and fee_flow.enter_time between #{start} and #{end} and exit_time is not null
    </select>

    <select id="findFeeMap" resultType="com.tgy.rtls.data.entity.park.FeeCalcul">
        SELECT
        COUNT(fee_flow.`id`) AS total_count,
        SUM(fee_flow.monthly_rent) AS non_monthlyRentCount,
        ROUND(SUM(TIMESTAMPDIFF(MINUTE ,fee_flow.enter_time,fee_flow.exit_time))/60/ COUNT(fee_flow.`id`),2) AS average_staytime,
        ROUND(SUM(fee_flow.fee),2) AS fee
        FROM fee_flow
        WHERE 1=1
        <if test="map!=null ">
            and map=#{map}
        </if>
        and fee_flow.enter_time between #{start} and #{end} and exit_time is not null and fee>0
    </select>





</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.check.TagcheckbsidDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.tgy.rtls.data.entity.check.TagcheckbsidEntity">
        <id column="id" property="id" />
        <result column="tagcheckid" property="tagcheckid" />
        <result column="bsid" property="bsid" />
        <result column="total" property="total" />
        <result column="currenttotal" property="currenttotal" />
        <result column="start" property="start" />
        <result column="end" property="end" />
        <result column="lackpercent" property="lackpercent" />
        <result column="lackedetail" property="lackedetail" />
        <result column="state" property="state" />
        <result column="period" property="period"/>
        <result column="currentdetail" property="currentdetail"/>
        <result column="totaldistinct" property="totaldistinct"/>
        <result column="finishtype" property="finishtype"/>
        <result column="checktime" property="checktime"/>
        <result column="type" property="type"/>


    </resultMap>
<!--    <cache type="com.tgy.rtls.data.config.RedisCache">
        <property name="eviction" value="LRU" />
        <property name="flushInterval" value="6000000" />
        <property name="size" value="1024" />
        <property name="readOnly" value="false" />
    </cache>-->
    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, tagcheckid, bsid, total, currenttotal, start, end, lackpercent, lackedetail, state,period,currentdetail,totaldistinct,finishtype,checktime,type
    </sql>

    <select id="getByTagcheckid" resultType="com.tgy.rtls.data.entity.check.TagcheckbsidEntity">
        SELECT a.id,a.tagcheckid,a.bsid,a.total,a.currenttotal,a.start,a.end,a.lackpercent,a.lackedetail,a.state,a.currentdetail,a.totaldistinct,a.finishtype,a.checktime,a.type,
        CASE a.end IS NULL and a.start is not null
        WHEN TRUE  THEN TIMESTAMPDIFF(SECOND,a.start,NOW())*1000
        WHEN FALSE THEN period
        END AS period FROM tagcheckbsid AS a WHERE 1=1
        <if test="tagcheckid!=null and tagcheckid!=''">
            and a.tagcheckid=#{tagcheckid}
        </if>
        <if test="type!=null and type!='' or type == 0">
            and a.type=#{type}
        </if>
        order by tagcheckid desc 

    </select>

    <select id="getByTagAndBsid" resultType="com.tgy.rtls.data.entity.check.TagcheckbsidEntity">
        select a.* ,TIMESTAMPDIFF(second ,a.start,NOW())*1000 AS period from tagcheckbsid as a,tagcheck as b where
        a.tagcheckid=b.id
        and a.bsid=#{bsid}
        and a.end is  null
        and a.state=1
        and b.taglist like concat ('%,',#{tagid},',%')
        and (not (a.currentdetail like concat ('%,',#{tagid},',%')) OR a.currentdetail IS NULL)
        GROUP BY tagcheckid
    </select>

    <select id="getALLNotEndTagCheckBsid" resultType="com.tgy.rtls.data.entity.check.TagcheckbsidEntity">
        select a.*  from tagcheckbsid as a where
         a.end is  null
        and a.state=1
    </select>
    <delete id="deleteByTagCheckid" >
        delete from tagcheckbsid where
        <if test="tagcheckid!=null and tagcheckid!=''">
            tagcheckid=#{tagcheckid}
        </if>
    </delete>
    <select id="getNotEnd" resultType="com.tgy.rtls.data.entity.check.TagcheckbsidEntity">
         select a.*  from tagcheckbsid as a,tagcheck as b where
        a.tagcheckid=b.id
        and a.bsid=#{bsid}
        and a.end is  null
        and a.state=1
        and b.taglist like concat ('%,',#{tagid},',%')
        GROUP BY tagcheckid
    </select>

    <select id="getNotEndTagCheck" resultType="com.tgy.rtls.data.entity.check.TagcheckEntity">
         select b.*  from tagcheckbsid as a,tagcheck as b where
        a.tagcheckid=b.id
        and a.bsid=#{bsid}
        and a.end is  null
        and a.state=1
    </select>

    <select id="getByCheckid" resultType="com.tgy.rtls.data.entity.check.TagcheckEntity">
         select *  from tagcheck  where
        id=#{tagcheckid}
    </select>

    <select id="getByTagcheckidAll" resultType="com.tgy.rtls.data.entity.check.TagcheckbsidEntity">
        SELECT a.* FROM tagcheckbsid AS a WHERE 1=1
        <if test="tagcheckid!=null and tagcheckid!=''">
            and a.tagcheckid=#{tagcheckid}
        </if>
    </select>

    <select id="getLackTagid" resultType="com.tgy.rtls.data.entity.check.TagcheckbsidEntity">
      SELECT tagid as tagcheckid FROM originaldata WHERE TIMESTAMP BETWEEN #{start} AND #{end} GROUP BY tagid
    </select>
    <update id="updateCheck">
        update tagcheckbsid
        <set>
            <if test="tagcheckbsid.total!=null ">
                total=#{tagcheckbsid.total},
            </if>
            <if test="tagcheckbsid.currenttotal!=null ">
                currenttotal=#{tagcheckbsid.currenttotal},
            </if>
            <if test="tagcheckbsid.start!=null ">
                start=#{tagcheckbsid.start},
            </if>
            <if test="tagcheckbsid.end!=null">
                end=#{tagcheckbsid.end},
            </if>
            <if test="tagcheckbsid.lackpercent!=null">
                lackpercent=#{tagcheckbsid.lackpercent},
            </if>
            <if test="tagcheckbsid.lackedetail!=null">
                lackedetail=#{tagcheckbsid.lackedetail},
            </if>
            <if test="tagcheckbsid.state!=null">
                state=#{tagcheckbsid.state},
            </if>
            <if test="tagcheckbsid.period!=null">
                period=#{tagcheckbsid.period},
            </if>
            <if test="tagcheckbsid.currentdetail!=null">
                currentdetail=#{tagcheckbsid.currentdetail},
            </if>
            <if test="tagcheckbsid.totaldistinct!=null">
                totaldistinct=#{tagcheckbsid.totaldistinct},
            </if>
            <if test="tagcheckbsid.finishtype!=null ">
                finishtype=#{tagcheckbsid.finishtype},
            </if>
            <if test="tagcheckbsid.checktime!=null ">
                checktime=#{tagcheckbsid.checktime},
            </if>
            <if test="tagcheckbsid.type!=null ">
                type=#{tagcheckbsid.type}
            </if>

        </set>
        where id=#{tagcheckbsid.id}
    </update>




</mapper>

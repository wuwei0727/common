<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.common.StatisticsMapper">
    <insert id="addManFlow">
        insert into manflow(map,count)
        values (#{map},#{count})
    </insert>

    <update id="updateManFlow">
        update manflow
        set endTime=#{endTime}
        where map=#{map} and endTime is null
    </update>

    <select id="selectManFlow" resultType="integer">
        select max(`count`)
        from manflow
        where map=#{map} and addTime>#{startTime} and #{endTime}>addTime
    </select>

    <select id="selectManFlowFromIncoalRecord" resultType="integer">
        select count(id)
        from incoalrecord
        where map=#{map} and inTime between #{startTime} and #{endTime}
    </select>

    <select id="selectManFlowLately"  resultType="integer">
        select `count`
        from manflow
        where map=#{map} and addTime=(select max(addTime) from manflow where #{startTime}>addTime)
/*        group by addTime*/
    </select>

    <select id="findByWarnFlow" resultType="com.tgy.rtls.data.entity.common.WarnFlow">
     SELECT   `status`.`typeid` AS `type`,`status`.color,`status`.name AS typeName,sdas.count FROM `status` LEFT JOIN
      (SELECT rec.type,rec.typeName,rec.color, COUNT(*) AS  `count` FROM
     (SELECT  s.typeid AS `type`,s.name AS typeName,s.color,w.startTime,w.endTime FROM warnrecord  w
     LEFT JOIN `status`  s ON w.type=s.typeid
     WHERE (w.map=#{map} || w.map=0) AND s.`type`='warn' and  w.startTime>#{startTime} AND #{endTime}>w.startTime) rec
     GROUP BY rec.type) sdas ON `status`.typeid=sdas.type WHERE `status`.type='warn'
    </select>

    <delete id="delManFlow">
        delete from manflow
        where map in
        <foreach collection="maps" separator="," close=")" open="(" item="map">
            #{map}
        </foreach>
    </delete>
</mapper>
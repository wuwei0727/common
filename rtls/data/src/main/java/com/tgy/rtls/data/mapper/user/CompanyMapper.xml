<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.user.CompanyMapper">

    <select id="findByAll" resultType="com.tgy.rtls.data.entity.user.Company">
        select *,
        (select count(1) from member where cid=id)as memberNum
        from company
        where 1=1
        <if test="keyword!=null and keyword!=''">
            and cname like concat('%',#{keyword},'%')
        </if>
        <if test="enabled!=null">
            and enabled=#{enabled}
        </if>
        <if test="cid!=null and cid!='' and cid!='1'.toString()">
            and id=#{cid}
        </if>
        <if test="desc!=null and desc!=''">
            order by ${desc}
        </if>
    </select>

    <select id="findByAll2" resultType="com.tgy.rtls.data.entity.user.Company">
        select *,
        (select count(1) from member where cid=id)as memberNum
        from company
        where 1=1
<!--        <if test="maps != null and maps != ''">-->
<!--            and m.id in-->
<!--            <foreach collection="maps" open="(" close=")"  separator="," item="maps">-->
<!--                #{maps}-->
<!--            </foreach>-->
<!--        </if>-->
        <if test="createuId != null and createuId != ''">
            and createuId = #{createuId}
        </if>
        <if test="keyword!=null and keyword!=''">
            and cname like concat('%',#{keyword},'%')
        </if>
        <if test="cname != null and cname != ''">
            and id = #{cname}
        </if>
        <if test="enabled!=null">
            and enabled=#{enabled}
        </if>
        <if test="cid!=null and cid!='' and cid!='1'.toString()">
            and id=#{cid}
        </if>
        <if test="desc!=null and desc!=''">
            order by ${desc}
        </if>
    </select>

    <select id="findByNameId" resultType="string">
        select group_concat(cname)
        from company
        where id in
        <foreach collection="ids" separator="," close=")" open="(" item="id">
            #{id}
        </foreach>
    </select>

    <select id="findById" resultType="com.tgy.rtls.data.entity.user.Company">
        select * ,
        (select count(1) from member where cid=id)as memberNum
        from company
        where id=#{id}
    </select>

    <select id="findByName" resultType="com.tgy.rtls.data.entity.user.Company">
        select *
          from company
         where cname=#{cname}
    </select>

    <insert id="insertCompany" keyProperty="id" useGeneratedKeys="true">
        insert into company(cname,`describe`,enabled,createuId)
        values (#{company.cname},#{company.describe},#{company.enabled},#{company.createuId})
    </insert>

    <update id="updateCompany">
        update company
        <set>
            enabled=#{company.enabled},
            <if test="company.cname!=null and company.cname!=''">
                 cname=#{company.cname},
            </if>
            <if test="company.describe!=null and company.describe!=''">
                `describe`=#{company.describe},
            </if>
        </set>
        where id=#{company.id}
    </update>
    <update id="updateMember">
        update member
        set enabled = #{enabled}
        where uid = #{uid};
    </update>


    <delete id="delCompany">
        delete from company
        where id=#{id}
    </delete>

    <delete id="delCompany_project">
        delete from sys_company_project
        where cid=#{cid}
        <if test="project_ids!=null and project_ids!=''">
            and pid not in
            <foreach collection="project_ids" close=")" open="(" separator="," item="pid">
                #{pid}
            </foreach>
        </if>
    </delete>

    <delete id="delCompany_projectId">
        delete from sys_company_project
        where pid=#{project_id}
    </delete>

    <select id="findByCid" resultType="int">
        select count(1)
          from sys_company_project
         where cid=#{cid} and pid=#{pid}
    </select>
    <select id="findMember" resultType="com.tgy.rtls.data.entity.user.Member">
        SELECT
            m.uid,
            m.membername,
            m.`password`,
            m.phone,
            m.enabled
        FROM
            member m
                LEFT JOIN company c ON c.id = m.cid
        WHERE
            c.id = #{cid}
    </select>
    <select id="findMemberByCid" resultType="com.tgy.rtls.data.entity.user.Member">
        SELECT
            m.uid,
            m.membername,
            m.`password`,
            m.phone,
            m.enabled,
            m.`describe`,
            m.addTime,
            m.loginTime,
            m.url,
            m.cid
        FROM
            member m
                LEFT JOIN company c ON c.id = m.cid
        WHERE
            c.id = #{cid}
    </select>


    <insert id="insertCompany_project">
        insert into sys_company_project(cid,pid)
        value (#{cid},#{pid})
    </insert>

    <select id="getCreateByuid" resultType="com.tgy.rtls.data.entity.user.Company">
        select c.id,c.cname,c.`describe`,c.enabled,c.addTime,c.createuId

        from company c left join member m on m.uid = c.createuId
        where m.uid = #{uid}
    </select>

    <select id="getMemberByCid" resultType="com.tgy.rtls.data.entity.user.Member">
        select uid, enabled, cid
        from member
        where cid in
        <foreach collection="cid" item="cid" separator="," open="(" close=")">
            #{cid}
        </foreach>

    </select>

    <update id="updateDisabledMemberByCid">
        update member
        set enabled = 0
        where cid = #{cid};
    </update>
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.warn.AlarmPersonnelBindingsMapper">
  <resultMap id="BaseResultMap" type="com.tgy.rtls.data.entity.warn.AlarmPersonnelBindings">
    <!--@mbg.generated-->
    <!--@Table alarm_personnel_bindings-->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="map" jdbcType="VARCHAR" property="map" />
    <result column="mapName" jdbcType="VARCHAR" property="mapName" />
    <result column="alarm_type_id" jdbcType="VARCHAR" property="alarmTypeId" />
    <result column="alarm_type_names" jdbcType="VARCHAR" property="alarmTypeNames" />
    <result column="maintenance_staff_id" jdbcType="VARCHAR" property="maintenanceStaffId" />
    <result column="maintenance_staff_names" jdbcType="VARCHAR" property="maintenanceStaffNames" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="level" jdbcType="VARCHAR" property="level" />
    <result column="level_names" jdbcType="VARCHAR" property="levelNames" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--@mbg.generated-->
    <!--@sql select -->
      apb.id,
      apb.`map`,
      m.name mapName,
      ms.phone phone,
      GROUP_CONCAT(DISTINCT apt.alarm_type_id) as alarm_type_id,
      GROUP_CONCAT(DISTINCT CONCAT(dt.name, '-', dt.alarm_name)) as alarm_type_names,
      GROUP_CONCAT(DISTINCT apl.level_id) as level,
      GROUP_CONCAT(DISTINCT
            CASE apl.level_id
              WHEN 1 THEN '高'
              WHEN 2 THEN '中'
              WHEN 3 THEN '低'
            END
            ORDER BY CASE apl.level_id WHEN 1 THEN 1
              WHEN 2 THEN 2
              WHEN 3 THEN 3
            END) as level_names,
      GROUP_CONCAT(DISTINCT ms.name) as staff_names,
      apb.maintenance_staff_id,
      GROUP_CONCAT(DISTINCT ms.name) as maintenance_staff_names,
      apb.create_time,
      apb.update_time
    <!--@sql
      FROM alarm_personnel_bindings apb
           LEFT JOIN map_2d m ON m.id = apb.map
           LEFT JOIN alarm_personnel_type_mappings apt ON apt.binding_id = apb.id
           LEFT JOIN alarm_personnel_level_mappings apl ON apl.binding_id = apb.id
           LEFT JOIN (
      SELECT dac.id, dt.name, dat.name as alarm_name,
             dt.id as type_id, dat.id as alarm_type_id
      FROM device_alarms_config dac
               LEFT JOIN device_type dt ON dt.id = dac.device_type_id
               LEFT JOIN device_alarms_type dat ON dat.id = dac.device_alarm_type_id
    ) dt ON dt.id = apt.alarm_type_id
           LEFT JOIN maintenance_staff ms ON ms.id = apb.maintenance_staff_id
    -->
  </sql>

  <!--$var desc=1-->
  <select id="getAllOrFilteredAlarmPersonnelBindings" resultMap="BaseResultMap">
    select <include refid="Base_Column_List"/>
    FROM alarm_personnel_bindings apb
    LEFT JOIN map_2d m ON m.id = apb.map
    LEFT JOIN alarm_personnel_type_mappings apt ON apt.binding_id = apb.id
    LEFT JOIN alarm_personnel_level_mappings apl ON apl.binding_id = apb.id
    LEFT JOIN (
        SELECT dac.id, dt.name, dat.name as alarm_name,dt.id as type_id, dat.id as alarm_type_id
        FROM device_alarms_config dac
        LEFT JOIN device_type dt ON dt.id = dac.device_type_id
        LEFT JOIN device_alarms_type dat ON dat.id = dac.device_alarm_type_id
    ) dt ON dt.id = apt.alarm_type_id
    LEFT JOIN maintenance_staff ms ON ms.id = apb.maintenance_staff_id
    WHERE 1=1
    <if test="map != null and map != ''">
      and apb.map = #{map}
    </if>
    <if test="mapids != null and mapids.length != 0">
      and m.id in
      <foreach collection="mapids" item="id" open="(" close=")" separator=",">
        #{id}
      </foreach>
    </if>
    GROUP BY apb.id
    <if test="desc != null and desc != ''">
      order by ${desc}
    </if>
  </select>

  <select id="getAlarmPersonnelBindingsById" resultMap="BaseResultMap">
    select <include refid="Base_Column_List"/>
    from alarm_personnel_bindings apb
    LEFT JOIN map_2d m ON m.id = apb.map
    LEFT JOIN alarm_personnel_type_mappings apt ON apt.binding_id = apb.id
    LEFT JOIN alarm_personnel_level_mappings apl ON apl.binding_id = apb.id
    LEFT JOIN (
      SELECT dac.id, dt.name, dat.name as alarm_name,dt.id as type_id, dat.id as alarm_type_id
      FROM device_alarms_config dac
      LEFT JOIN device_type dt ON dt.id = dac.device_type_id
      LEFT JOIN device_alarms_type dat ON dat.id = dac.device_alarm_type_id
      ) dt ON dt.id = apt.alarm_type_id
    LEFT JOIN maintenance_staff ms ON ms.id = apb.maintenance_staff_id
    where apb.id= #{id}

  </select>

  <select id="getBindingsByCondition" resultMap="BaseResultMap">
    select <include refid="Base_Column_List"/>
    from alarm_personnel_bindings apb
    LEFT JOIN map_2d m ON m.id = apb.map
    LEFT JOIN alarm_personnel_type_mappings apt ON apt.binding_id = apb.id
    LEFT JOIN alarm_personnel_level_mappings apl ON apl.binding_id = apb.id
    LEFT JOIN (
    SELECT dac.id, dt.name, dat.name as alarm_name,dt.id as type_id, dat.id as alarm_type_id
    FROM device_alarms_config dac
    LEFT JOIN device_type dt ON dt.id = dac.device_type_id
    LEFT JOIN device_alarms_type dat ON dat.id = dac.device_alarm_type_id
    ) dt ON dt.id = apt.alarm_type_id
    LEFT JOIN maintenance_staff ms ON ms.id = apb.maintenance_staff_id
    where apb.map= #{map} and dt.alarm_type_id=#{type} and apl.level_id=#{priority}
    GROUP BY apb.id
  </select>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.routing.RouteRecordMapper">
    <resultMap id="Routetask" type="com.tgy.rtls.data.entity.routing.Routetask">
        <id column="id" property="id"/>
        <result column="personid" property="personid"/>
        <collection property="person" column="personid" javaType="int" ofType="com.tgy.rtls.data.entity.user.PersonVO" select="findByPerson"/>
    </resultMap>

    <select id="findByTask" resultMap="Routetask">
        select *
        from routetask
        where month=#{month} and instanceid=#{instanceid} and personid is not null
    </select>

    <select id="findByTaskRid" resultMap="Routetask">
        select *
        from routetask
        where month=#{month} and rid=#{rid}
    </select>

    <select id="findByRoute" resultType="com.tgy.rtls.data.entity.routing.Route">
        select *
        from route
        where id in (select rid from routetask where month=#{month})
        and map in (select id from map_2d where instanceid=#{instanceid})
    </select>

    <select id="findByRoutedotId" resultType="com.tgy.rtls.data.entity.routing.Routedot">
        select *
        from routedot
        where rid in (select rid from routetask where month =#{month} and day=#{day} and personid=#{personid})
        and id not in (select rdid from routerecord where month =#{month} and day=#{day} and personid=#{personid})
    </select>

    <select id="findByRouteRecordId" resultType="com.tgy.rtls.data.entity.routing.Routerecord">
        select *
        from routerecord
        where month=#{month} and day=#{day} and personid=#{personid} and rdid=#{rdid}
    </select>

    <insert id="addRoutetask" useGeneratedKeys="true" keyProperty="id">
        insert into routetask(month,day,rid,personid,instanceid)
        values (#{task.month},#{task.day},#{task.rid},#{task.personid},#{task.instanceid})
    </insert>

    <update id="updateRoutetask">
        update routetask
        <if test="task.personid!=null">
            set personid=#{task.personid}
        </if>
        <if test="task.personid==null">
            set personid=null
        </if>
        where id=#{task.id}
    </update>

    <delete id="delRoutetask">
        delete from routetask
        where rid=#{id}
        <if test="month!=null">
            and month=#{month}
        </if>

    </delete>
    <delete id="delRoutetaskByid">
        delete from routetask
        where id=#{id}

    </delete>

    <resultMap id="RouteVO" type="com.tgy.rtls.data.entity.routing.RouteVO">
        <id column="id" property="id"/>
        <result column="personid" property="personid"/>
        <collection property="routedotVOs"  column="{month=month,day=day,personid=personid,id=id}" javaType="ArrayList" ofType="com.tgy.rtls.data.entity.routing.RoutedotVO" select="findByRoutedotVO"/>
        <collection property="person" column="personid" javaType="int" ofType="com.tgy.rtls.data.entity.user.PersonVO" select="findByPerson"/>
    </resultMap>


    <select id="findByRouteRecord" resultMap="RouteVO">
        select rid as id,personid,month,day
        from routetask
        where month=#{month}  and rid=#{rid}
        <if test="keyword!=null and keyword!=''">
            and personid in
            (SELECT cc.id FROM (SELECT person.id,worktype.`name` AS wtname,person.name AS pname FROM person LEFT JOIN worktype ON  person.`worktype`=worktype.`id`
            HAVING  wtname LIKE CONCAT('%',#{keyword},'%')
            OR pname LIKE CONCAT('%',#{keyword},'%')  ) cc
            )
        </if>
    </select>

    <select id="findByRouteData" resultType="com.tgy.rtls.data.entity.routing.RouteData">
        select id,name
        from route
        where map in (select id from map_2d where instanceid=#{instanceid})
        and id in (select rid from routetask group by rid)
        <if test="name!=null and name!=''">
            and name like  concat('%',#{name},'%')
        </if>
        <if test="map!=null and map!=''">
            and map =#{map}
        </if>


    </select>

    <select id="findByRoutedotVO" resultType="com.tgy.rtls.data.entity.routing.RoutedotVO">
        select rdid as id,arriveTime,status,
        (select name from routedot where id=rdid)as name,
        (select startTime from routedot where id=rdid)as startTime,
        (select endTime from routedot where id=rdid)as endTime
        from routerecord
        where month =#{month} and day=#{day} and personid=#{personid}
        and rdid in (select id from routedot where rid=#{id})
    </select>

    <select id="findByPerson" resultType="com.tgy.rtls.data.entity.user.PersonVO">
        select id,name,num,
        (select name from job where id=p.job)as jobName,
        (select name from department where id=p.department)as departmentName,
        (select name from level where id=p.level)as levelName,
        (select name from worktype where id=p.worktype)as worktypeName,
        (select num from tag where id=p.tagid)as tagName,
        (select ${name} from status where type='online' and typeid=(select status from tag where id=p.tagid))as statusName
        from person p
        where id=#{personid}
    </select>

    <insert id="addRouteRecord" useGeneratedKeys="true" keyProperty="id">
        insert into routerecord(month,day,personid,rdid,arriveTime,status)
        values (#{record.month},#{record.day},#{record.personid},#{record.rdid},#{record.arriveTime},#{record.status})
    </insert>
</mapper>
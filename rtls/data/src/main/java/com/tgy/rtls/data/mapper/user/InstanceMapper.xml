<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.user.InstanceMapper">
    <select id="findByAll" resultType="com.tgy.rtls.data.entity.user.Instance">
        SELECT *
        FROM instance
        where 1=1
        <if test="name!=null and name!=''">
            and name like concat('%',#{name},'%')
        </if>
        <if test="userid!=null and userid!=''">
            and id in(select pid from sys_member_project where uid=#{userid})
        </if>
        order by time desc
    </select>

    <select id="findById" resultType="com.tgy.rtls.data.entity.user.Instance">
        SELECT *
        FROM instance
        where id=#{id}
    </select>

    <select id="findByNameId" resultType="string">
        SELECT name
        FROM instance
        where id=#{id}
    </select>

    <select id="findByCid" resultType="com.tgy.rtls.data.entity.user.Instance">
        select *
        from instance
        where id in(select pid from sys_company_project where cid=#{cid})
    </select>

    <select id="findByUid" resultType="com.tgy.rtls.data.entity.user.Instance">
        select *
        from instance
        where id in(select pid from sys_member_project where uid=#{uid})
    </select>

    <select id="findByNum" resultType="com.tgy.rtls.data.entity.user.Instance">
        SELECT *
        FROM instance
        where num=#{num}
    </select>

    <select id="findByCode2" resultType="com.tgy.rtls.data.entity.user.Instance">
        SELECT *
        FROM instance
        where code2=#{code2}
    </select>

    <insert id="addInstance" useGeneratedKeys="true" keyProperty="id">
        insert into instance(name,num,code1,code2)
        value (#{instance.name},#{instance.num},#{instance.code1},#{instance.code2})
    </insert>
    
    <update id="updateInstance">
        update instance
        <set>
            <if test="instance.name!=null and instance.name!=''">
                name=#{instance.name},
            </if>
            <if test="instance.num!=null and instance.num!=''">
                num=#{instance.num},
            </if>
            <if test="instance.code1!=null and instance.code1!=''">
                code1=#{instance.code1},
            </if>
            <if test="instance.code2!=null and instance.code2!=''">
                code2=#{instance.code2},
            </if>
        </set>
        where id=#{instance.id}
    </update>
    
    <delete id="delInstance">
        delete from instance
        where id=#{id}
    </delete>

    <insert id="addEventlogType">
        insert into eventlogtype(name,instanceid)
        values ('出井',#{instanceid}),
        ('入井',#{instanceid})
    </insert>

    <delete id="delEventlogType">
        delete from eventlogtype
        where instanceid=#{instanceid}
    </delete>

    <select id="delPerson" resultType="string">
        select  GROUP_CONCAT(id)
        from person
        where instanceid=#{instanceid}
    </select>

    <delete id="delAreaType">
        delete from area_type
        where instanceid=#{instanceid}
    </delete>

    <delete id="delTag">
        delete from tag
        where instanceid=#{instanceid}
    </delete>

    <delete id="delDepartment">
        delete from department
        where instanceid=#{instanceid}
    </delete>
    <delete id="delWorktype">
        delete from worktype
        where instanceid=#{instanceid}
    </delete>
    <delete id="delJob">
        delete from job
        where instanceid=#{instanceid}
    </delete>
    <delete id="delLevel">
        delete from level
        where instanceid=#{instanceid}
    </delete>
    <delete id="delScheduling">
        delete from scheduling
        where instanceid=#{instanceid}
    </delete>
    <delete id="delTextrecord">
        delete from textrecord
        where instanceid=#{instanceid}
    </delete>
    <delete id="delVoicerecord">
        delete from voicerecord
        where instanceid=#{instanceid}
    </delete>

</mapper>
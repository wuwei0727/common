<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.park.RecommConfigMapper">
    <resultMap id="BaseResultMap" type="com.tgy.rtls.data.entity.park.RecommConfig">
        <!--@mbg.generated-->
        <!--@Table recommconfig-->
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="placeList" jdbcType="VARCHAR" property="placeList"/>
        <result column="map" jdbcType="VARCHAR" property="map"/>
        <result column="mapName" jdbcType="VARCHAR" property="mapName"/>
        <result column="appName" jdbcType="VARCHAR" property="appName"/>
        <result column="mapKey" jdbcType="VARCHAR" property="mapKey"/>
        <result column="fmapID" jdbcType="VARCHAR" property="fmapID"/>
        <result column="mapImg" jdbcType="VARCHAR" property="mapImg"/>
        <result column="themeImg" jdbcType="VARCHAR" property="themeImg"/>
        <result column="areaName" jdbcType="VARCHAR" property="areaname"/>
        <result column="recommelevel" jdbcType="TINYINT" property="recommelevel"/>
        <result column="starttime" jdbcType="TIMESTAMP" property="starttime"/>
        <result column="endtime" jdbcType="TIMESTAMP" property="endtime"/>

        <result column="areaQuFen" jdbcType="VARCHAR" property="areaQuFen"/>

        <collection property="vertexInfo" javaType="java.util.List" ofType="com.tgy.rtls.data.entity.park.RecommConfigArea">
            <result column="areaQuFen" jdbcType="INTEGER" property="areaQuFen"/>
            <collection property="points" javaType="java.util.List" ofType="com.tgy.rtls.data.entity.park.RecommConfigArea">
                <result column="x" jdbcType="VARCHAR" property="x"/>
                <result column="y" jdbcType="VARCHAR" property="y"/>
                <result column="floor" jdbcType="VARCHAR" property="floor"/>
            </collection>
        </collection>
    </resultMap>

    <sql id="Base_Column_List">
        <!--@mbg.generated-->
        <!--@sql select -->
        r.id,
        r.`map`,
        r.areaName,
        r.recommelevel,
        r.starttime,
        r.endtime,
        rc.x,
        rc.y,
        rc.`floor`,
        rc.`areaQuFen`,
        m2d.name as                                  mapName,
        m2d.mapKey,
        m2d.appName,
        m2d.fmapID,
        m2d.themeImg,
        m2d.mapImg,
        GROUP_CONCAT(distinct pp.NAME SEPARATOR ',') placeList
        <!--@sql from recommconfig r
                 left join recommConfigAreaVertexCoordinateInfo rai on r.id = rai.recommConfigId
                 left join recommConfigAreaVertexCoordinate rc on rai.id = rc.areaId
                 left join recommConfigAreaPlace rap on rai.id = rap.areaId
                 left join parking_place pp on rap.placeId = pp.id
                 left join map_2d m2d on r.map = m2d.id
        -->
    </sql>
    <update id="updateBatch" parameterType="java.util.List">
        <!--@mbg.generated-->
        update recommconfig
        <trim prefix="set" suffixOverrides=",">
            <trim prefix="`map` = case" suffix="end,">
                <foreach collection="list" index="index" item="item">
                    when id = #{item.id,jdbcType=BIGINT} then #{item.map,jdbcType=VARCHAR}
                </foreach>
            </trim>
            <trim prefix="areaName = case" suffix="end,">
                <foreach collection="list" index="index" item="item">
                    when id = #{item.id,jdbcType=BIGINT} then #{item.areaname,jdbcType=VARCHAR}
                </foreach>
            </trim>
            <trim prefix="recommelevel = case" suffix="end,">
                <foreach collection="list" index="index" item="item">
                    when id = #{item.id,jdbcType=BIGINT} then #{item.recommelevel,jdbcType=TINYINT}
                </foreach>
            </trim>
            <trim prefix="starttime = case" suffix="end,">
                <foreach collection="list" index="index" item="item">
                    when id = #{item.id,jdbcType=BIGINT} then #{item.starttime,jdbcType=TIMESTAMP}
                </foreach>
            </trim>
            <trim prefix="endtime = case" suffix="end,">
                <foreach collection="list" index="index" item="item">
                    when id = #{item.id,jdbcType=BIGINT} then #{item.endtime,jdbcType=TIMESTAMP}
                </foreach>
            </trim>
        </trim>
        where id in
        <foreach close=")" collection="list" item="item" open="(" separator=", ">
            #{item.id,jdbcType=BIGINT}
        </foreach>
    </update>
    <insert id="batchInsert" keyColumn="id" keyProperty="id" parameterType="map" useGeneratedKeys="true">
        <!--@mbg.generated-->
        insert into recommconfig
            (`map`, areaName, recommelevel, starttime, endtime)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.map,jdbcType=VARCHAR}, #{item.areaname,jdbcType=VARCHAR}, #{item.recommelevel,jdbcType=TINYINT},
             #{item.starttime,jdbcType=TIMESTAMP}, #{item.endtime,jdbcType=TIMESTAMP})
        </foreach>
    </insert>
    <!--$var desc=q-->
    <select id="getAllRecommConfigOrConditionQuery" resultType="com.tgy.rtls.data.entity.park.RecommConfig">
        select r.id,
               r.`map`,
               r.areaName,
               r.recommelevel,
               r.starttime,
               r.endtime,
               rc.x,
               rc.y,
               rc.`floor`,
               rc.`areaQuFen`,
               m2d.name as                                  mapName,
               m2d.mapKey,
               m2d.appName,
               m2d.fmapID,
               m2d.themeImg,
               m2d.mapImg,
               GROUP_CONCAT(distinct pp.NAME SEPARATOR ',') placeList
        from recommconfig r
                 left join recommConfigAreaVertexCoordinateInfo rai on r.id = rai.recommConfigId
                 left join recommConfigAreaVertexCoordinate rc on rai.id = rc.areaId
                 left join recommConfigAreaPlace rap on rai.id = rap.areaId
                 left join parking_place pp on rap.placeId = pp.id
                 left join map_2d m2d on r.map = m2d.id
        <where>
            1 = 1
            <if test="map != null and map != ''">
                and r.map = #{map}
            </if>
            <if test="areaname != null and areaname != ''">
                and r.areaname like concat('%',#{areaname},'%')
            </if>
            <if test="recommelevel != null and recommelevel != ''">
                and r.recommelevel = #{recommelevel}
            </if>
            <if test="mapids != null and mapids != ''">
                and m2d.id in
                <foreach close=")" collection="mapids" item="mapids" open="(" separator=",">
                    #{mapids}
                </foreach>
            </if>
            <!--                        group BY x,r.id desc-->
            group BY r.id
            <if test="desc != null and desc != ''">
                order by ${desc}
            </if>
        </where>
    </select>

    <insert id="addRecommConfig" keyProperty="id" useGeneratedKeys="true">
        insert into recommconfig (`map`, areaName, recommelevel, starttime, endtime)
        values (#{map}, #{areaname}, #{recommelevel}, #{starttime}, #{endtime})
    </insert>

    <insert id="addRecommConfigAreaVertexCoordinate" keyProperty="id" useGeneratedKeys="true">
        insert into recommConfigAreaVertexCoordinateInfo (recommConfigId)
        values (#{recommConfigId})
    </insert>

    <insert id="addRecommConfigArea" keyProperty="id" useGeneratedKeys="true">
        insert into recommConfigAreaVertexCoordinate (x, y, floor, areaId, areaQuFen)
        values (#{x}, #{y}, #{floor}, #{areaId}, #{areaQuFen})
    </insert>

    <insert id="addRecommConfigAreaPlace">
        insert into recommConfigAreaPlace (areaId, placeId)
        values (#{areaid}, #{placeid})
    </insert>


    <delete id="delRecommConfig">
        delete
        from recommconfig
        where id = #{id}
    </delete>

    <delete id="delRecommConfigAreaVertexCoordinate">
        delete
        from recommConfigAreaVertexCoordinate
        where areaId = #{id}
    </delete>

    <delete id="delRecommConfigAreaHost">
        delete
        from recommConfigAreaVertexCoordinateInfo
        where recommConfigId = #{id}
    </delete>

    <delete id="delRecommConfigByAreaId">
        delete
        from recommConfigAreaPlace
        where areaId = #{areaId}
    </delete>

    <update id="updateRecommConfig">
        update recommconfig
        <set>
            <if test="map != null and map != ''">
                map = #{map},
            </if>
            <if test="areaname != null and areaname != ''">
                areaname = #{areaname},
            </if>
            <if test="recommelevel != null and recommelevel != ''">
                recommelevel = #{recommelevel},
            </if>
            <if test="starttime != null">
                starttime = #{starttime},
            </if>
            <if test="endtime != null">
                endtime = #{endtime},
            </if>
        </set>
        where id = #{id};
    </update>

    <update id="updateRecommConfigArea">
        update recommConfigAreaVertexCoordinate
        <set>
            <if test="x != null and x != ''">
                x = #{x},
            </if>
            <if test="y != null and y != ''">
                y = #{y},
            </if>
            <if test="areaQuFen != null and areaQuFen != ''">
                areaQuFen = #{areaQuFen},
            </if>
        </set>
        where id = #{id};
    </update>

    <update id="updateRecommConfigAreaPlace">
        update recommConfigAreaPlace
        <set>
            <if test="areaid != null">
                areaId = #{areaid},
            </if>
            <if test="placeid != null">
                placeId = #{placeid}
            </if>
        </set>
        where areaId = #{areaid};
    </update>

    <select id="getRecommConfigById" resultMap="BaseResultMap">
        <!--查看单个-->
        select r.id,
               r.`map`,
               r.areaName,
               r.recommelevel,
               r.starttime,
               r.endtime,
               rc.x,
               rc.y,
               rc.`floor`,
               rc.`areaQuFen`,
               m2d.name as                                  mapName,
               m2d.mapKey,
               m2d.appName,
               m2d.fmapID,
               m2d.themeImg,
               m2d.mapImg,
               GROUP_CONCAT(distinct pp.NAME SEPARATOR ',') placeList
        from recommconfig r -- 主表纯信息
                 left join recommConfigAreaVertexCoordinateInfo rai on r.id = rai.recommConfigId -- -- 区域表信息
                 left join recommConfigAreaVertexCoordinate rc on rai.id = rc.areaId -- 区域表子表
                 left join recommConfigAreaPlace rap on rai.id = rap.areaId -- 区域车位表信息
                 left join parking_place pp on rap.placeId = pp.id -- 车位纯信息
                 left join map_2d m2d on r.map = m2d.id -- 地图纯信息
        where 1=1
        <if test="idstr != null and idstr != '' and idstr.equals('update')">
            <if test="id != null and id != ''">and r.id != #{id}</if>
        </if>
        <if test="idstr != null and idstr != ''and idstr.equals('see')">
            <if test="id != null and id != ''">and r.id = #{id}</if>
        </if>

        <if test="placeId != null and placeId != ''">and rap.placeId = #{placeId}</if>
        GROUP BY rc.id, x, y, floor desc
    </select>

    <select id="getPlaceByPlaceNames" resultType="com.tgy.rtls.data.entity.park.ParkingPlace">
        select id,
               name,
               x,
               y,
               z,
               map,
               company,
               floor,
               state,
               fid,
               addTime
        from parking_place
        where map = #{mapId}
          and name = #{placeName}
    </select>

    <select id="getRecommConfigByAreaId" resultType="com.tgy.rtls.data.entity.park.RecommConfig">
        select r.id,
               r.`map`,
               r.areaName,
               r.recommelevel,
               r.starttime,
               r.endtime,
               rai.id   as                                  areaId,
               rap.id   as                                  areaPlaceId,
               rc.x,
               rc.y,
               rc.`floor`,
               rc.`areaQuFen`,
               m2d.name as                                  mapName,
               m2d.mapKey,
               m2d.appName,
               m2d.fmapID,
               m2d.themeImg,
               m2d.mapImg,
               GROUP_CONCAT(distinct pp.NAME SEPARATOR ',') placeList
        from recommconfig r -- 主表纯信息
                 left join recommConfigAreaVertexCoordinateInfo rai on r.id = rai.recommConfigId -- -- 区域表信息
                 left join recommConfigAreaVertexCoordinate rc on rai.id = rc.areaId -- 区域表子表
                 left join recommConfigAreaPlace rap on rai.id = rap.areaId -- 区域车位表信息
                 left join parking_place pp on rap.placeId = pp.id -- 车位纯信息
                 left join map_2d m2d on r.map = m2d.id -- 地图纯信息
        where r.id = #{id}
    </select>

    <select id="getRecommConfigByPlaceId" resultType="com.tgy.rtls.data.entity.park.RecommConfig">
<!--        select rcap.id, rcap.areaId as areaid,rcap.placeId as placeid-->
<!--        from recommConfigAreaPlace rcap-->
<!--        where 1=1  id = #{placeId}-->
    </select>
</mapper>
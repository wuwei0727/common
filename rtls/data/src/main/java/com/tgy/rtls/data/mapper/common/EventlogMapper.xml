<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.common.EventlogMapper">
    <select id="findByAll" resultType="com.tgy.rtls.data.entity.common.Eventlog">
        SELECT finnnn.*,eventlogtypesimple.${name} as typeSimpleName FROM( SELECT * FROM ( select finn.*,department.name as departmentName from (select
        fin.*,person.department from ( SELECT *,
        (SELECT NAME FROM person WHERE id=personid
        )AS personName,
        (SELECT num FROM tag WHERE id=(SELECT tagid FROM person WHERE id=personid))AS tagName,
        (select name from map_2d where id=map)as mapName
        FROM eventlog
        where map in (select id from map_2d where instanceid=#{instanceid})
        <if test="startTime!='' and startTime!=null and endTime!='' and endTime!=null">
            and time>#{startTime} and #{endTime}>time
        </if>
        <if test="map!=null and map!=''">
            and map=#{map}
        </if>
    <!--    <if test="type!=null and type!=''">
            and type=#{type}
        </if>-->
        <if test="typeSimple!=null and typeSimple!=''">
            and typesimple=#{typeSimple}
        </if>
        order by time desc) fin left join person on fin.personid=person.id) finn left join department on
        department.id=finn.department
        <if test="departmentId!=null and departmentId!=''">
            WHERE department.id=#{departmentId}
        </if>
        ) finnn WHERE 1=1
        <if test="personName!=null and personName!=''">
            and personName like concat('%',#{personName},'%')
        </if>) finnnn left join eventlogtypesimple on finnnn.typesimple=eventlogtypesimple.id

    </select>

    <insert id="addEventlog">
        insert into eventlog(personid,map,event,typesimple,bsid)
        value (#{eventlog.personid},#{eventlog.map},#{eventlog.event},#{eventlog.typeSimple},#{eventlog.bsid})
    </insert>



    <select id="findByType" resultType="com.tgy.rtls.data.entity.common.EventlogType">
        select *
        from eventlogtype
        where instanceid=#{instanceid}
    </select>

    <select id="findByTypeSimple" resultType="com.tgy.rtls.data.entity.common.EventlogType">
        select id,${name}
        from eventlogtypesimple
    </select>

    <select id="findByTypeSimpleBsid" resultType="com.tgy.rtls.data.entity.common.EventlogType">
        select *
        from eventlog where 1=1
        <if test="bsid!=null and bsid!=''">
            and bsid =#{bsid}
        </if>
        <if test="personid!=null and personid!=''">
            and personid =#{personid}
        </if> order by `time` desc limit 1

    </select>

    <select id="findByEventlogType" resultType="int">
        select id
        from eventlogtype
        where name=#{name} and instanceid=#{instanceid}
    </select>
</mapper>
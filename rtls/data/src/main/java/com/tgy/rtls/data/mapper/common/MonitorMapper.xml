<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.common.MonitorMapper">
    <select id="findByProject" resultType="com.tgy.rtls.data.entity.common.Monitor">
        SELECT COUNT(1)AS manNumber,
        COUNT(DISTINCT(personid))AS manTime,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))),#{timeformat})AS totalHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(1)),#{timeformat})AS timeHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(DISTINCT(personid))),#{timeformat})AS percapitaHours,
        ${instanceid} as id,
        (select name from instance where id=#{instanceid})as name
        FROM incoalrecord
        WHERE (map IN (select id from map_2d where instanceid=#{instanceid})) AND outTime IS NOT NULL
        <if test="map!=null and map !=''">
            and FIND_IN_SET(map,#{map})
        </if>
        <if test="departmentid!=null and departmentid!=''">
            and personid in (select id from person where  FIND_IN_SET(department,#{departmentid}))
        </if>
        <if test="jobid!=null and jobid!=''">
            and personid in (select id from person where  FIND_IN_SET(job,#{jobid}))
        </if>
        <if test="worktypeid!=null and worktypeid!=''">
            and personid in (select id from person where FIND_IN_SET(worktype,#{worktypeid}))
        </if>
        <if test="startTime!=null and endTime!=null and startTime!='' and endTime !=''">
            and inTime>#{startTime} and #{endTime}>outTime
        </if>
        HAVING totalHours IS NOT NULL
        order by inTime desc
    </select>

    <select id="findByMap" resultType="com.tgy.rtls.data.entity.common.Monitor">
        SELECT COUNT(1)AS manNumber,
        COUNT(DISTINCT(personid))AS manTime,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))),#{timeformat})AS totalHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(1)),#{timeformat})AS timeHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(DISTINCT(personid))),#{timeformat})AS percapitaHours,
        map as id,
        (select name from map_2d where id=map)as name
        FROM incoalrecord
        WHERE (map IN (select id from map_2d where instanceid=#{instanceid}))   AND outTime IS NOT NULL
        <if test="map!=null and map !=''">
            and FIND_IN_SET(map,#{map})
        </if>
        <if test="departmentid!=null and departmentid!=''">
            and personid in (select id from person where  FIND_IN_SET(department,#{departmentid}))
        </if>
        <if test="jobid!=null and jobid!=''">
            and personid in (select id from person where  FIND_IN_SET(job,#{jobid}))
        </if>
        <if test="worktypeid!=null and worktypeid!=''">
            and personid in (select id from person where FIND_IN_SET(worktype,#{worktypeid}))
        </if>
        <if test="startTime!=null and endTime!=null and startTime!='' and endTime !=''">
            and inTime>#{startTime} and  #{endTime}>outTime
        </if>
        group by map
        HAVING totalHours IS NOT NULL
    </select>

    <select id="findByMapId" resultType="com.tgy.rtls.data.entity.common.Monitor">
        SELECT COUNT(1)AS manNumber,
        COUNT(DISTINCT(personid))AS manTime,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))),#{timeformat})AS totalHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(1)),#{timeformat})AS timeHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(DISTINCT(personid))),#{timeformat})AS percapitaHours,
        map as id,
        (select name from map_2d where id=map)as name
        FROM incoalrecord
        WHERE ( map IN (select id from map_2d where instanceid=#{instanceid}))  AND outTime IS NOT NULL
        <if test="map!=null and map !=''">
            and FIND_IN_SET(map,#{map})
        </if>
        <if test="departmentid!=null and departmentid!=''">
            and personid in (select id from person where  FIND_IN_SET(department,#{departmentid}))
        </if>
        <if test="jobid!=null and jobid!=''">
            and personid in (select id from person where  FIND_IN_SET(job,#{jobid}))
        </if>
        <if test="worktypeid!=null and worktypeid!=''">
            and personid in (select id from person where FIND_IN_SET(worktype,#{worktypeid}))
        </if>
        <if test="startTime!=null and endTime!=null and startTime!='' and endTime !=''">
            and inTime>#{startTime} and #{endTime}>outTime
        </if>
        HAVING totalHours IS NOT NULL
    </select>

    <select id="findByArea" resultType="com.tgy.rtls.data.entity.common.MonitorArea">
        SELECT COUNT(1)AS manNumber,
        COUNT(DISTINCT(personid))AS manTime,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))),#{timeformat})AS totalHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(1)),#{timeformat})AS timeHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(DISTINCT(personid))),#{timeformat})AS percapitaHours,
        area as id,
        (select name from map_2d where id=map)as mapName,
        (select id from map_2d where id=map)as mapId,
        (select name from area where id=area)as name,
        (select name from area_type where id=(select type from area where id=area))as typeName
        FROM inarearecord
        WHERE (map IN (select id from map_2d where instanceid=#{instanceid})) AND outTime IS NOT NULL
        <if test="map!=null and map !=''">
            and FIND_IN_SET(map,#{map})
        </if>
        <if test="departmentid!=null and departmentid!=''">
            and personid in (select id from person where  FIND_IN_SET(department,#{departmentid}))
        </if>
        <if test="jobid!=null and jobid!=''">
            and personid in (select id from person where  FIND_IN_SET(job,#{jobid}))
        </if>
        <if test="worktypeid!=null and worktypeid!=''">
            and personid in (select id from person where FIND_IN_SET(worktype,#{worktypeid}))
        </if>
        <if test="startTime!=null and endTime!=null and startTime!='' and endTime !=''">
            and inTime>#{startTime} and #{endTime}>outTime
        </if>
        group by area
        HAVING totalHours IS NOT NULL
    </select>

    <select id="findByAreaId" resultType="com.tgy.rtls.data.entity.common.MonitorArea">
        SELECT COUNT(1)AS manNumber,
        COUNT(DISTINCT(personid))AS manTime,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))),#{timeformat})AS totalHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(1)),#{timeformat})AS timeHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(DISTINCT(personid))),#{timeformat})AS percapitaHours,
        area as id,
        (select name from map_2d where id=map)as mapName,
        (select name from area where id=area)as name,
        (select name from area_type where id=(select type from area where id=area))as typeName
        FROM inarearecord
        WHERE (map IN (select id from map_2d where instanceid=#{instanceid}))  AND outTime IS NOT NULL
        <if test="map!=null and map !=''">
            and FIND_IN_SET(map,#{map})
        </if>
        <if test="area!=null and area!=''">
            and area in(${area})
        </if>
        <if test="departmentid!=null and departmentid!=''">
            and personid in (select id from person where  FIND_IN_SET(department,#{departmentid}))
        </if>
        <if test="jobid!=null and jobid!=''">
            and personid in (select id from person where  FIND_IN_SET(job,#{jobid}))
        </if>
        <if test="worktypeid!=null and worktypeid!=''">
            and personid in (select id from person where FIND_IN_SET(worktype,#{worktypeid}))
        </if>
        <if test="startTime!=null and endTime!=null and startTime!='' and endTime !=''">
            and inTime>#{startTime} and #{endTime}>outTime
        </if>
        HAVING totalHours IS NOT NULL
    </select>

    <select id="findBySub" resultType="com.tgy.rtls.data.entity.common.MonitorSub">
        SELECT COUNT(1)AS manNumber,
        COUNT(DISTINCT(personid))AS manTime,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))),#{timeformat})AS totalHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(1)),#{timeformat})AS timeHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(DISTINCT(personid))),#{timeformat})AS percapitaHours,
        (SELECT id FROM substation WHERE num= s.num)AS id,num,
        (SELECT name FROM map_2d WHERE id=map)AS mapName,
        (select id from map_2d where id=map)as mapId,
        (SELECT ${name} FROM bstype WHERE id=(SELECT TYPE FROM substation WHERE num=s.num) AND class='type')AS typeName
        FROM `insubrecord` s
        WHERE  (map IN (select id from map_2d where instanceid=#{instanceid}))  AND outTime IS NOT NULL
        <if test="map!=null and map !=''">
            and FIND_IN_SET(map,#{map})
        </if>
        <if test="departmentid!=null and departmentid!=''">
            and personid in (select id from person where FIND_IN_SET(department,#{departmentid}))
        </if>
        <if test="jobid!=null and jobid!=''">
            and personid in (select id from person where  FIND_IN_SET(job,#{jobid}))
        </if>
        <if test="worktypeid!=null and worktypeid!=''">
            and personid in (select id from person where FIND_IN_SET(worktype,#{worktypeid}))
        </if>
        <if test="startTime!=null and endTime!=null and startTime!='' and endTime !=''">
            and inTime>#{startTime} and #{endTime}>outTime
        </if>
        group by num
        HAVING totalHours IS NOT NULL
    </select>

    <select id="findBySubId" resultType="com.tgy.rtls.data.entity.common.MonitorSub">
        SELECT COUNT(1)AS manNumber,
        COUNT(DISTINCT(personid))AS manTime,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))),#{timeformat})AS totalHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(1)),#{timeformat})AS timeHours,
        TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND,inTime,outTime))/COUNT(DISTINCT(personid))),#{timeformat})AS percapitaHours,
        (SELECT id FROM substation WHERE num= s.num)AS id,num,
        (SELECT NAME FROM map_2d WHERE id=map)AS mapName,
        (SELECT ${name} FROM bstype WHERE id=(SELECT TYPE FROM substation WHERE num=s.num) AND class='type')AS typeName
        FROM `insubrecord` s
        WHERE  (map IN (select id from map_2d where instanceid=#{instanceid}))  AND outTime IS NOT NULL
        <if test="map!=null and map !=''">
            and FIND_IN_SET(map,#{map})
        </if>
        <if test="sub!=null and sub!=''">
            and num in (select num from substation where id in(${sub}))
        </if>
        <if test="departmentid!=null and departmentid!=''">
            and personid in (select id from person where  FIND_IN_SET(department,#{departmentid}))
        </if>
        <if test="jobid!=null and jobid!=''">
            and personid in (select id from person where  FIND_IN_SET(job,#{jobid}))
        </if>
        <if test="worktypeid!=null and worktypeid!=''">
            and personid in (select id from person where FIND_IN_SET(worktype,#{worktypeid}))
        </if>
        <if test="startTime!=null and endTime!=null and startTime!='' and endTime !=''">
            and inTime>#{startTime} and #{endTime}>outTime
        </if>
        HAVING totalHours IS NOT NULL
    </select>

    <select id="findByAreatype" resultType="com.tgy.rtls.data.entity.common.MonitorAreatype">
        SELECT DISTINCT((SELECT name FROM area_type WHERE id=type))AS typeName
        FROM area
        where map in
        <foreach collection="map" separator="," close=")" open="(" item="mapid">
            #{mapid}
        </foreach>
    </select>

    <select id="findByAreatypeName" resultType="com.tgy.rtls.data.entity.map.Area">
        select *,
       (select name from area_type where id=type)as typeName
        from area
        where map in
        <foreach collection="map" separator="," close=")" open="(" item="mapid">
            #{mapid}
        </foreach>
        having typeName=#{typeName}
    </select>

    <select id="findBySubtype" resultType="com.tgy.rtls.data.entity.common.MonitorSubtype">
        SELECT DISTINCT((SELECT ${name} FROM bstype WHERE id=type))AS typeName
        FROM substation
          where map in
        <foreach collection="map" separator="," close=")" open="(" item="mapid">
            #{mapid}
        </foreach>
    </select>

    <select id="findBySubtypeName" resultType="com.tgy.rtls.data.entity.equip.Substation">
        select *,
       (select ${name} from bstype where id=type)as typeName
        from substation
        where map in
        <foreach collection="map" separator="," close=")" open="(" item="mapid">
            #{mapid}
        </foreach>
        having typeName=#{typeName}
    </select>

    <select id="findByProjectPerson" resultType="com.tgy.rtls.data.entity.common.MonitorPerson">
        SELECT personid as id,inTime,outTime,
        (select name from person where id=personid)as name,
        (select num from person where id=personid)as num,
        (select name from job where id=(select job from person where id=personid))as jobName,
        (select name from department where id=(select department from person where id=personid))as departmentName,
        (select name from worktype where id=(select worktype from person where id=personid))as worktypeName,
        TIME_FORMAT(TIMEDIFF(outTime,inTime),#{timeformat}) AS duration
        FROM incoalrecord
        WHERE outTime IS NOT NULL
        AND map IN (select id from map_2d where instanceid=#{instanceid})
        <if test="departmentid!=null and departmentid!=''">
            and personid in (select id from person where  FIND_IN_SET(department,#{departmentid}))
        </if>
        <if test="jobid!=null and jobid!=''">
            and personid in (select id from person where  FIND_IN_SET(job,#{jobid}))
        </if>
        <if test="worktypeid!=null and worktypeid!=''">
            and personid in (select id from person where FIND_IN_SET(worktype,#{worktypeid}))
        </if>
        <if test="startTime!=null and endTime!=null and startTime!='' and endTime !=''">
            and inTime>#{startTime} and  #{endTime}>outTime
        </if>
        order by inTime desc
    </select>

    <select id="findByMapPerson" resultType="com.tgy.rtls.data.entity.common.MonitorPerson">
        SELECT personid as id,inTime,outTime,
        (select name from person where id=personid)as name,
        (select num from person where id=personid)as num,
        (select name from job where id=(select job from person where id=personid))as jobName,
        (select name from department where id=(select department from person where id=personid))as departmentName,
        (select name from worktype where id=(select worktype from person where id=personid))as worktypeName,
        TIME_FORMAT(TIMEDIFF(outTime,inTime),#{timeformat}) AS duration
        FROM incoalrecord
        WHERE outTime IS NOT NULL
        AND map IN (select id from map_2d where instanceid=#{instanceid})
        <if test="map!=null and map!=''">
            and FIND_IN_SET(map,#{map})
        </if>
        <if test="departmentid!=null and departmentid!=''">
            and personid in (select id from person where FIND_IN_SET(department,#{departmentid}) )
        </if>
        <if test="jobid!=null and jobid!=''">
            and personid in (select id from person where FIND_IN_SET(job,#{jobid}))
        </if>
        <if test="worktypeid!=null and worktypeid!=''">
            and personid in (select id from person where FIND_IN_SET(worktype,#{worktypeid}))
        </if>
        <if test="startTime!=null and endTime!=null and startTime!='' and endTime !=''">
            and inTime>#{startTime} and #{endTime}>outTime
        </if>
        order by inTime desc
    </select>

    <select id="findByAreaPerson" resultType="com.tgy.rtls.data.entity.common.MonitorPerson">
        SELECT personid as id,inTime,outTime,
        (select name from person where id=personid)as name,
        (select num from person where id=personid)as num,
        (select name from job where id=(select job from person where id=personid))as jobName,
        (select name from department where id=(select department from person where id=personid))as departmentName,
        (select name from worktype where id=(select worktype from person where id=personid))as worktypeName,
        TIME_FORMAT(TIMEDIFF(outTime,inTime),#{timeformat}) AS duration
        FROM inarearecord
        WHERE outTime IS NOT NULL
        AND map IN (select id from map_2d where instanceid=#{instanceid})
        <if test="map!=null and map!=''">
            and FIND_IN_SET(map,#{map})
        </if>
        <if test="area!=null and area!=''">
            and  FIND_IN_SET(area,#{area})
        </if>

        <if test="departmentid!=null and departmentid!=''">
            and personid in (select id from person where FIND_IN_SET(department,#{departmentid}) )
        </if>
        <if test="jobid!=null and jobid!=''">
            and personid in (select id from person where FIND_IN_SET(job,#{jobid}))
        </if>
        <if test="worktypeid!=null and worktypeid!=''">
            and personid in (select id from person where FIND_IN_SET(worktype,#{worktypeid}))
        </if>
        <if test="startTime!=null and endTime!=null and startTime!='' and endTime !=''">
            and inTime>#{startTime} and #{endTime}>outTime
        </if>
        order by inTime desc
    </select>

    <select id="findBySubPerson" resultType="com.tgy.rtls.data.entity.common.MonitorPerson">
        SELECT personid as id,inTime,outTime,
        (select name from person where id=personid)as name,
        (select num from person where id=personid)as num,
        (select name from job where id=(select job from person where id=personid))as jobName,
        (select name from department where id=(select department from person where id=personid))as departmentName,
        (select name from worktype where id=(select worktype from person where id=personid))as worktypeName,
        TIME_FORMAT(TIMEDIFF(outTime,inTime),#{timeformat}) AS duration
        FROM insubrecord
        WHERE outTime IS NOT NULL
        AND map IN (select id from map_2d where instanceid=#{instanceid})
        <if test="map!=null and map!=''">
            and FIND_IN_SET(map,#{map})
        </if>
        <if test="sub!=null and sub!=''">
            and num in (select num from substation where  FIND_IN_SET(id,#{sub}))
        </if>
        <if test="departmentid!=null and departmentid!=''">
            and personid in (select id from person where FIND_IN_SET(department,#{departmentid}))
        </if>
        <if test="jobid!=null and jobid!=''">
            and personid in (select id from person where FIND_IN_SET(job,#{jobid}))
        </if>
        <if test="worktypeid!=null and worktypeid!=''">
            and personid in (select id from person where FIND_IN_SET(worktype,#{worktypeid}))
        </if>
        <if test="startTime!=null and endTime!=null and startTime!='' and endTime !=''">
            and inTime>#{startTime} and #{endTime}>outTime
        </if>
        order by inTime desc
    </select>
</mapper>
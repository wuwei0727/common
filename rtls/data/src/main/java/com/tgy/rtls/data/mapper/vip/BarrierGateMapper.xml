<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.vip.BarrierGateMapper">
    <resultMap id="BaseResultMap" type="com.tgy.rtls.data.entity.vip.BarrierGate">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="device_num" jdbcType="VARCHAR" property="deviceNum"/>
        <result column="map" jdbcType="BIGINT" property="map"/>
        <result column="binding_area" jdbcType="VARCHAR" property="bindingArea"/>
        <result column="state" jdbcType="TINYINT" property="state"/>
        <result column="floor" jdbcType="BIGINT" property="floor"/>
        <result column="startTime" jdbcType="TIMESTAMP" property="startTime"/>
        <result column="endTime" jdbcType="TIMESTAMP" property="endTime"/>

        <result column="x" jdbcType="VARCHAR" property="x"/>
        <result column="y" jdbcType="VARCHAR" property="y"/>
        <result column="z" jdbcType="VARCHAR" property="z"/>
        <result column="fid" jdbcType="VARCHAR" property="fid"/>
        <result column="mapName" jdbcType="VARCHAR" property="mapName"/>
        <result column="appName" jdbcType="VARCHAR" property="appName"/>
        <result column="mapKey" jdbcType="VARCHAR" property="mapKey"/>
        <result column="fmapID" jdbcType="VARCHAR" property="fmapID"/>
        <result column="mapImg" jdbcType="VARCHAR" property="mapImg"/>
        <result column="themeImg" jdbcType="VARCHAR" property="themeImg"/>
    </resultMap>

    <resultMap id="areaNameList" type="com.tgy.rtls.data.entity.park.ParkingCompanyVo">
        <result property="mapId" column="mapId"/>
        <result property="mapName" column="mapName"/>
        <collection property="areaNameList" ofType="com.tgy.rtls.data.entity.park.ParkingCompanyVo">
            <result property="barrierGateId" column="barrierGateId"/>
            <result property="areaName" column="areaName"/>
        </collection>
    </resultMap>


    <select id="getAllAreaNameByMapId" resultMap="areaNameList">
        select m.id            as mapId,
               m.name          as mapName,
               bg.id           as barrierGateId,
               bg.binding_area as areaName
        from map_2d as m
                 left join barrier_gate bg on m.id = bg.map
        where 1 = 1
          and m.enable != 0
        <if test="mapIds != '' and mapIds != null">
            and m.id in
            <foreach collection="mapIds" open="(" close=")" separator="," item="mapIds">
                #{mapIds}
            </foreach>
        </if>
        order by mapId
    </select>

    <sql id="Base_Column_List">
        <!--@sql select -->b.id,
                           b.device_num,
                           b.map,
                           b.binding_area,
                           b.floor,
                           mrf.name as floorName,
                           b.x,
                           b.y,
                           b.z,
                           b.fid,
                           b.state,
                           b.start_time as startTime,
                           b.end_time   as endTime,
                           m2d.name     as mapName,
                           m2d.mapKey,
                           m2d.appName,
                           m2d.fmapID,
                           m2d.mapImg,
                           m2d.themeImg,
                           b.id            barrierGateId,
                           b.binding_area  areaName
        <!--@sql from barrier_gate b left join map_2d m2d on m2d.id = b.map left join map_relevance_floor mrf on mrf.map = m2d.id-->
    </sql>

    <select id="getBarrierGateInfo" resultMap="BaseResultMap">
        select distinct
        <include refid="Base_Column_List"/>
        from barrier_gate b
                 left join map_2d m2d on m2d.id = b.map
                 left join map_relevance_floor mrf on mrf.map = m2d.id AND mrf.level = b.floor
        where 1 = 1
        <if test="map != null">
            and b.map = #{map}
        </if>
        <if test="state != null">
            and b.state = #{state}
        </if>
        <if test="floorName != null and floorName != ''">
            and mrf.name like concat('%',#{floorName},'%')
        </if>
        <if test="vipArea != null and vipArea != ''">
            and b.id = #{vipArea}
        </if>
        <if test="barrierGateNum != null and barrierGateNum != ''">
            and b.device_num like concat('%', #{barrierGateNum}, '%')
        </if>
        <if test="mapids != null and mapids != ''">
            and m2d.id in
            <foreach close=")" collection="mapids" item="maps" open="(" separator=",">
                #{maps}
            </foreach>
        </if>
        <if test="desc != null and desc != ''">
            order by ${desc}
        </if>
    </select>

    <insert id="addBarrierGateInfo">
        insert into barrier_gate (device_num, map, binding_area, floor, x, y, fid)
        values (
        <if test="deviceNum != null and deviceNum != ''">
            #{deviceNum},
        </if>
        <if test="map != null">
            #{map},
        </if>
        <if test="bindingArea != null and bindingArea != ''">
            #{bindingArea},
        </if>
        <if test="floor != null">
            #{floor},
        </if>
        <if test="x != null and x != ''">
            #{x},
        </if>
        <if test="y != null and y != ''">
            #{y},
        </if>
        <if test="fid != null and fid != ''">
            #{fid}
        </if>
        )
    </insert>

    <update id="editBarrierGateInfo">
        update barrier_gate
        set
        <if test="map != null">
            map = #{map},
        </if>
        <if test="deviceNum != null and deviceNum != ''">
            device_num = #{deviceNum},
        </if>
        <if test="bindingArea != null and bindingArea != ''">
            binding_area = #{bindingArea},
        </if>
        <if test="floor != null">
            floor = #{floor},
        </if>
        <if test="x != null and x != ''">
            x = #{x},
        </if>
        <if test="y != null and y != ''">
            y =#{y},
        </if>
        <if test="z != null and z != ''">
            z = #{z},
        </if>
        <if test="fid != null and fid != ''">
            fid = #{fid}
        </if>
        where id = #{id}
    </update>

    <delete id="delBarrierGateInfo">
        delete
        from barrier_gate
        where id = #{id}
    </delete>

    <select id="getBarrierGateInfoInfoById" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from barrier_gate b
                 left join map_2d m2d on m2d.id = b.map
        left join map_relevance_floor mrf on mrf.map = m2d.id AND mrf.level = b.floor
        where b.id = #{id}
    </select>

    <select id="getBarrierGateInfoInfoByNum" resultMap="BaseResultMap">
        select distinct
        <include refid="Base_Column_List"/>
        from barrier_gate b
                 left join map_2d m2d on m2d.id = b.map
        left join map_relevance_floor mrf on mrf.map = m2d.id AND mrf.level = b.floor

        where device_num = #{num}
    </select>

    <select id="getConditionData" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from barrier_gate b
                 left join map_2d m2d on m2d.id = b.map
        left join map_relevance_floor mrf on mrf.map = m2d.id AND mrf.level = b.floor

        where 1 = 1
        <if test="deviceNum != null and deviceNum != ''">
            and device_num = #{deviceNum}
        </if>
        <if test="bingingArea != null and bingingArea != ''">
            and binding_area = #{bingingArea}
        </if>
        <if test="update != null and update != ''">
         and b.id != #{update}
        </if>
    </select>
</mapper>
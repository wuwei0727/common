<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.warn.WhitelistSlotsMapper">
  <resultMap id="BaseResultMap" type="com.tgy.rtls.data.entity.warn.WhitelistSlots">
    <!--@mbg.generated-->
    <!--@Table whitelist_slots-->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="config_id" jdbcType="INTEGER" property="configId" />
    <result column="mapId" jdbcType="INTEGER" property="mapId" />
    <result column="mapName" jdbcType="VARCHAR" property="mapName" />
    <result column="place_id" jdbcType="VARCHAR" property="placeId" />
    <result column="placeName" jdbcType="VARCHAR" property="placeName" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--@mbg.generated-->
    <!--@sql select -->
    ws.id, ws.place_id ,GROUP_CONCAT(DISTINCT p.name) as placeName, ws.config_id,m.id mapId,m.name mapName,ws.create_time,ws.update_time
    <!--@sql  from whitelist_slots ws left join parking_place p on p.id = ws.place_id left join map_2d m on p.map = m.id -->
  </sql>

  <!--$var desc=1-->
  <select id="getAllOrFilteredWhitelist" resultMap="BaseResultMap">
    select <include refid="Base_Column_List" />
    from whitelist_slots ws
      LEFT JOIN (SELECT id, name, map FROM parking_place WHERE FIND_IN_SET(id, (SELECT GROUP_CONCAT(DISTINCT place_id) FROM whitelist_slots))) p ON FIND_IN_SET(p.id, ws.place_id)
      LEFT JOIN map_2d m ON p.map = m.id
    where 1=1
    <if test="mapId != null and mapId != ''">
      and m.id = #{mapId}
    </if>
    <if test="mapids != null and mapids != ''">
      and m.id in
      <foreach close=")" collection="mapids" item="mapids" open="(" separator=",">
        #{mapids}
      </foreach>
    </if>

    GROUP BY
    ws.id,
    ws.place_id,
    ws.config_id,
    m.id,
    m.name,
    ws.create_time,
    ws.update_time

    <if test="desc != null and desc != ''">
      order by ${desc}
    </if>
  </select>

  <select id="getWhitelistById" resultMap="BaseResultMap">
    select <include refid="Base_Column_List" />
    from whitelist_slots ws
        left join parking_place p on p.id = place_id
        left join map_2d m on p.map = m.id
    where ws.id = #{id}
  </select>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tgy.rtls.data.mapper.location.LocationMapper">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.tgy.rtls.data.entity.location.Originaldata">
        <result column="id" property="id" />
        <result column="filter_dis" property="filter_dis" />
        <result column="original_dis" property="original_dis" />
        <result column="tagid" property="tagid" />
        <result column="rangebsid" property="rangebsid" />
        <result column="lr" property="lr" />
    </resultMap>
    <insert id="addOriginaldata">
        insert into originaldata(tagid,rangid,upbsid,rangebsid,rx3,ft1c,ft2c,ft3c,ft4c,rssi,rssifp,original_dis,filter_dis,lr,x,y)
        value (#{originaldata.tagid},#{originaldata.rangid},#{originaldata.upbsid},#{originaldata.rangebsid},#{originaldata.rx3},
        #{originaldata.ft1c},#{originaldata.ft2c},#{originaldata.ft3c},#{originaldata.ft4c},#{originaldata.rssi},
        #{originaldata.rssifp},#{originaldata.original_dis},#{originaldata.filter_dis},#{originaldata.lr},#{originaldata.x},#{originaldata.y})
    </insert>

    <insert id="addTdoaData">
        insert into tdoa(tagid,src,target,src_tx,target_rx,src_t,target_t,diff,x,y)
        value (#{tdoaData.tagid},#{tdoaData.src},#{tdoaData.target},
        #{tdoaData.src_tx},#{tdoaData.target_rx},#{tdoaData.src_t},
        #{tdoaData.target_t},#{tdoaData.diff},
         #{tdoaData.x},#{tdoaData.y}
        )
    </insert>
    <insert id="addBeacondata">
            INSERT INTO beacondata(bsid,beacon_src,beacon_id,beacon_txTs,beacon_rxTs,beacon_rssi,beacon_fp,x,y)
            VALUE (#{beacondata.bsid},#{beacondata.beacon_src},#{beacondata.beacon_id},#{beacondata.beacon_txTs},#{beacondata.beacon_rxTs},
            #{beacondata.beacon_rssi},#{beacondata.beacon_fp},#{beacondata.x},#{beacondata.y})
    </insert>
    <insert id="addTrailrecord">
        insert into trailrecord(`time`,area,personid,x,y,z,`type`,mapid,r,floor,debugdata,`name`,num)
        value (#{trailrecord.time},#{trailrecord.area},#{trailrecord.personid},#{trailrecord.x},#{trailrecord.y},#{trailrecord.z},
        #{trailrecord.type},#{trailrecord.mapid},#{trailrecord.r},#{trailrecord.floor},#{trailrecord.debugData},,#{trailrecord.name},#{trailrecord.num})
    </insert>
    <insert id="insertRecovery">
        insert into recovery_data(`timestamp`,tagid,rangid,bsid,rx3,ft1,ft2,ft3,ft4,rssi,fp,lr)
        value (#{recovery.timestamp},#{recovery.tagid},#{recovery.rangid},#{recovery.bsid},#{recovery.rx3},#{recovery.ft1},
        #{recovery.ft2},#{recovery.ft3},#{recovery.ft4},#{recovery.rssi},#{recovery.fp},#{recovery.lr})
    </insert>

    <select id="getLackTagidFromRecovery" resultType="com.tgy.rtls.data.entity.check.TagcheckbsidEntity">
        SELECT tagid as tagcheckid  FROM recovery_data where `timestamp` between #{start} and #{end} group by tagid
    </select>

    <select id="findByTrail" resultType="com.tgy.rtls.data.entity.location.Trailrecord">
        select id,area,personid,`time`,x,y,z,`type`,mapid
        from trailrecord
        where mapid=#{map}
        <if test="personid!=null">
        and personid=#{personid}
        </if>
        <if test="name!=null">
            and `name`=#{name}
        </if>
        <if test="num!=null">
            and num=#{num}
        </if>
       <!-- <if test="name!=null and name!=''">
        and personid in (select id from person where name=#{name})
        </if>-->
        <if test="startTime!=null and endTime!=null and startTime!='' and startTime!=''">
            and time>#{startTime} and #{endTime}>time
        </if>
    </select>

    <select id="findByTrailWithDebugData" resultType="com.tgy.rtls.data.entity.location.DebugRecord">
        SELECT `x` AS `x`, `y` AS `y`, z AS z, debugdata as debugdata,mapid AS map, `time` AS `time`,(SELECT num  FROM tag WHERE id=#{id}) AS tagid,#{id} as `id`,area as area
        from trailrecord
        where mapid=#{map}
            and personid = (select id from person where tagid=#{id})
        <if test="startTime!=null and endTime!=null and startTime!='' and startTime!=''">
            and time>#{startTime} and #{endTime}>time
        </if>
    </select>

    <insert id="addDiag">
        insert into diag(isTx,frametype,uwbdata,hasdiag,diag,`timestamp`,uwb_error,upbsid,x,y)
        value (#{diagdata.isTx},#{diagdata.frametype},#{diagdata.uwbdata},#{diagdata.hasdiag},#{diagdata.diag},#{diagdata.timestamp},#{diagdata.uwb_error},#{diagdata.upbsid},#{diagdata.x},#{diagdata.y})
        </insert>

   <!-- <insert id="addTrailrecord">
        insert into trailrecord(area,personid,x,y,z,`type`,mapid,debugdata)
        value (#{trailrecord.area},#{trailrecord.personid},#{trailrecord.x},#{trailrecord.y},#{trailrecord.z},#{trailrecord.type},#{trailrecord.mapid},#{trailrecord.debugdata})
    </insert>-->

    <select id="getOriginalDataByBsidAndTagid" resultMap="BaseResultMap">
        SELECT * FROM ( SELECT * FROM originaldata WHERE 1=1
        <if test="bsid!=null and bsid!=''">
            and  rangebsid=#{bsid}
        </if>
        <if test="tagid!=null and tagid!=''">
            and  tagid=#{tagid}
        </if>
         GROUP BY id DESC ) AS a
        GROUP BY a.lr

    </select>
    <select id="gettest" resultType="com.tgy.rtls.data.entity.location.Batch" >
        SELECT * FROM track WHERE 1=1
        <if test="batchID!=null and batchID!=''">
            and  batchID=#{batchID}
        </if>


    </select>

</mapper>